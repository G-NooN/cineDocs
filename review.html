<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>리뷰 작성</title>
    <link rel="stylesheet" href="./style/review.css" />
    <link rel="stylesheet" href="./style/reset.css" />
    <script type="module" src="./src/main.js"></script>
  </head>
  <body>
    <div class="review-box">
      <form id="comment-form">
        <div class="user-info">
          <input type="text" id="username" placeholder="이름" required />
          <input
            type="password"
            id="user-password"
            placeholder="비밀번호"
            required
          />
        </div>
        <div class="comment-area">
          <textarea
            id="comment"
            placeholder="리뷰를 입력하세요."
            required
          ></textarea>
          <button type="button" id="submit-btn" onclick="saveComment()">
            등록
          </button>
        </div>
      </form>
      <div id="comment-list"></div>
    </div>
  </body>
  <script>
    function saveComment() {
      const name = document.querySelector('#username').value;
      const password = document.querySelector('#user-password').value;
      const commentText = document.querySelector('#comment').value;

      //유효성 검사(빈칸일 때)
      if (name === '') {
        alert('이름을 입력하세요.');
        setTimeout(function () {
          const inputText = document.getElementById('username');
          if (inputText) {
            inputText.focus();
          }
        });
        return;
      } else if (password === '') {
        alert('비밀번호를 입력하세요.');
        setTimeout(function () {
          const inputText = document.getElementById('user-password');
          if (inputText) {
            inputText.focus();
          }
        });
        return;
      } else if (commentText === '') {
        alert('내용을 입력하세요.');
        setTimeout(function () {
          const imputText = document.getElementById('comment');
          if (imputText) {
            imputText.focus();
          }
        });
        return;
      }

      //유효성 검사(글자 수 제한)
      const maxLength = 15;
      if (commentText.length > maxLength) {
        alert('리뷰는 15자 이하여야 합니다.');
        setTimeout(function () {
          const imputText = document.getElementById('comment');
          if (imputText) {
            imputText.focus();
          }
        });
        return;
      }

      const comment = {
        name,
        password,
        commentText,
      };

      const commentsList =
        JSON.parse(localStorage.getItem('comment-list')) || [];

      commentsList.unshift(comment);
      localStorage.setItem('comment-list', JSON.stringify(commentsList));

      alert('리뷰가 등록되었습니다.');
      document.getElementById('username').value = '';
      document.getElementById('user-password').value = '';
      document.getElementById('comment').value = '';
      //input칸 비우기

      displayComments();
    }

    function displayComments() {
      const commentBox = document.querySelector('#comment-list');
      commentBox.innerHTML = '';

      const commentList =
        JSON.parse(localStorage.getItem('comment-list')) || [];

      commentList.forEach((comment, index) => {
        const newComment = document.createElement('div');
        newComment.className = 'comment-item';
        newComment.innerHTML = `
        <div class="comment-box">
          <div class="comment-data">
            <p class="comment-name">${comment.name}</p>
            <p class="comment-contents">${comment.commentText}</p>
          </div>
          <div class="control-btn" id="control-btn">
            <button onclick="editComment(${index})" id="editCommentBtn">수정</button>
            <button onclick="deleteComment(${index})" id="deleteCommentBtn">삭제</button>
          </div>
        </div>`;

        commentBox.appendChild(newComment);
      });
    }

    //리뷰 삭제
    function deleteComment(index) {
      const commentList =
        JSON.parse(localStorage.getItem('comment-list')) || [];
      const comment = commentList[index]; //배열 commentList에서 특정 index에 위치한 요소를 가져와 comment라는 변수에 할당하였다.

      const commentBox = document.getElementById('comment-list');

      const passwordInput = document.createElement('div');
      passwordInput.innerHTML = `
        <div class="passwordInputForm" id="passwordInputForm">
          <input type="password" id="confirmPassword" placeholder="비밀번호 입력" required/>
          <div id="confirmButtons">
          <button type="button" onclick="checkPasswordDelete(${index})">확인</button>
          <button type="button" id="cancelEditBtn"
          onclick="cancelEdit(${index})">취소</button>
          </div>
          </div>
        `;

      const passwordInputId = `passwordInput_${index}`;

      const makePasswordInput = document.getElementById(passwordInputId);
      if (makePasswordInput) {
        commentBox.replaceChild(passwordInput, makePasswordInput);
      } else {
        const buttonsContainer =
          commentBox.children[index].querySelector('#control-btn');
        buttonsContainer.replaceWith(passwordInput);
      }
    } //비밀번호 입력칸이 다른 리뷰 칸에 생성되는 일이 있어서, passwordInput에 인덱스값을 붙여 특정해주고 수정, 삭제 버튼이 있던 위치에 비밀번호 입력칸과 확인, 취소 버튼이 오게 하였다.

    //삭제 시 비밀번호 확인
    function checkPasswordDelete(index) {
      const commentList =
        JSON.parse(localStorage.getItem('comment-list')) || [];
      const comment = commentList[index];
      const enteredPassword = document.getElementById('confirmPassword').value;

      if (enteredPassword === comment.password) {
        commentList.splice(index, 1); //해당 인덱스를 가진 리뷰를 1개만 삭제한다. 1이라는 숫자를 넣어주지 않으면 해당 인덱스를 가진 리뷰를 포함해 먼저 작성된 리뷰들이 전부 삭제된다.
        localStorage.removeItem('comment-list');
        localStorage.setItem('comment-list', JSON.stringify(commentList)); //업데이트된 commentList를 다시 comments로 저장한다.
        alert('리뷰가 삭제되었습니다.');
        displayComments();
      } else if (enteredPassword === '') {
        alert('비밀번호를 입력해주세요.');
        setTimeout(function () {
          const inputText = document.getElementById('confirmPassword');
          if (inputText) {
            inputText.focus();
          }
        });
      } else {
        alert('비밀번호가 틀렸습니다.');
        setTimeout(function () {
          const inputText = document.getElementById('confirmPassword');
          if (inputText) {
            inputText.focus();
          }
        });
      }
    }

    //삭제 취소버튼 누를시 실행되는 함수.
    function cancelEdit(index) {
      const commentList =
        JSON.parse(localStorage.getItem('comment-list')) || [];

      if (index < 0 || index >= commentList.length) {
        return;
      } //주어진 index가 유효한 범위에 있는지 확인.

      const comment = commentList[index];
      //주어진 index에 해당하는 댓글 가져오기
      const commentBox = document.getElementById('comment-list');

      const cancelEditBtn = document.getElementById('cancelEditBtn');
      if (cancelEditBtn) {
        cancelEditBtn.removeEventListener('click', function () {
          cancelEdit(index);
        });
      } //cancelEditBtn이 존재한다면, 이전에(삭제버튼을 눌렀을 때) 등록된 이벤트 리스너를 제거한다.

      canceledComment(index);
      //해당 인덱스에 있는 댓글을 다시 표시
    }

    //삭제 버튼을 누르기 전, 수정, 삭제 버튼이 있는 리뷰를 보여준다.
    function canceledComment(index) {
      const commentBox = document.getElementById('comment-list');
      const commentList =
        JSON.parse(localStorage.getItem('comment-list')) || [];

      if (index < 0 || index >= commentList.length) {
        return;
      } //index가 유효한 범위에 있는지 확인

      const comment = commentList[index];

      const newComment = document.createElement('div');
      newComment.className = 'comment-item';
      newComment.innerHTML = `
    <div class="comment-box">
      <div class="comment-data">
        <p class="comment-name">${comment.name}</p>
        <p class="comment-contents">${comment.commentText}</p>
      </div>
      <div class="control-btn" id="control-btn">
        <button onclick="editComment(${index})" id="editCommentBtn">수정</button>
        <button onclick="deleteComment(${index})" id="deleteCommentBtn">삭제</button>
      </div>
    </div>`;

      commentBox.replaceChild(newComment, commentBox.children[index]);
    }
    //삭제 버튼을 눌러 비밀번호 input과 확인, 취소 버튼을 만들때 passwordInput 요소들이 수정, 삭제 버튼을 포함한 buttonsContainer 자리를 대신했기 때문에, 취소 버튼을 눌렀을때 passwordInput이 만들어지기 전의 buttonsContainer이 있던 리뷰의 모습을 다시 불러오기 위해서 리뷰를 다시 만들었다.

    displayComments();

    // window.localStorage.clear();
  </script>
</html>
