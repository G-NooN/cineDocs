<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>리뷰 작성</title>
    <link rel="stylesheet" href="review.css" />
    <link rel="stylesheet" href="./style/reset.css" />
  </head>
  <body>
    <div id="reviewBox">
      <form id="commentForm">
        <div id="upperText">
          <input type="text" id="name" placeholder="이름" required />
          <input
            type="password"
            id="password"
            placeholder="비밀번호"
            required
          />
        </div>
        <div id="commentArea">
          <textarea
            id="comment"
            placeholder="리뷰를 입력하세요."
            required
          ></textarea>
          <button type="button" id="button" onclick="saveComment()">
            리뷰 등록
          </button>
        </div>
      </form>
      <div id="comments"></div>
    </div>
  </body>
  <script>
    function saveComment() {
      const name = document.getElementById('name').value;
      const password = document.getElementById('password').value;
      const commentText = document.getElementById('comment').value;

      //유효성 검사(빈칸일 때)
      if (name === '') {
        alert('이름을 입력하세요.');
        setTimeout(function () {
          const inputText = document.getElementById('name');
          if (inputText) {
            inputText.focus();
          }
        });
        return;
      } else if (password === '') {
        alert('비밀번호를 입력하세요.');
        setTimeout(function () {
          const inputText = document.getElementById('password');
          if (inputText) {
            inputText.focus();
          }
        });
        return;
      } else if (commentText === '') {
        alert('내용을 입력하세요.');
        setTimeout(function () {
          const imputText = document.getElementById('comment');
          if (imputText) {
            imputText.focus();
          }
        });
        return;
      }

      //유효성 검사(글자 수 제한)
      const maxLength = 15;
      if (commentText.length > maxLength) {
        alert('리뷰는 15자 이하여야 합니다.');
        setTimeout(function () {
          const imputText = document.getElementById('comment');
          if (imputText) {
            imputText.focus();
          }
        });
        return;
      }

      const comment = {
        name,
        password,
        commentText,
      };

      const commentsList = JSON.parse(localStorage.getItem('comments')) || [];

      commentsList.unshift(comment);
      localStorage.setItem('comments', JSON.stringify(commentsList));

      alert('리뷰가 등록되었습니다.');

      displayComments();
    }

    function displayComments() {
      const commentBox = document.getElementById('comments');
      commentBox.innerHTML = '';

      const commentList = JSON.parse(localStorage.getItem('comments')) || [];

      commentList.forEach((comment, index) => {
        const newComment = document.createElement('div');
        newComment.innerHTML = `<div class="comment-Box"><p id="commentName">${comment.name}</p>
          <p id="commentContents">${comment.commentText}</p>
          <div id="buttons">
          <button onclick="editComment(${index})" id="editCommentBtn">수정</button>
          <button onclick="deleteComment(${index})" id="deleteCommentBtn">삭제</button>
          </div>
        </div>`;

        commentBox.appendChild(newComment);
      });
    }

    //리뷰 삭제
    function deleteComment(index) {
      const commentList = JSON.parse(localStorage.getItem('comments')) || [];
      const comment = commentList[index]; //배열 commentList에서 특정 index에 위치한 요소를 가져와 comment라는 변수에 할당하였다.

      const commentBox = document.getElementById('comments');

      const passwordInput = document.createElement('div');
      passwordInput.innerHTML = `
        <div class="passwordInputForm">
          <input type="password" id="confirmPassword" placeholder="비밀번호 입력" required/>
          <div id="confirmButtons">
          <button type="button" onclick="checkPasswordDelete(${index})">확인</button>
          <button type="button"
          onclick="cancelEdit(${index})">취소</button>
          </div>
          </div>
        `;

      const passwordInputId = `passwordInput_${index}`;

      const makePasswordInput = document.getElementById(passwordInputId);
      if (makePasswordInput) {
        commentBox.replaceChild(passwordInput, makePasswordInput);
      } else {
        const buttonsContainer =
          commentBox.children[index].querySelector('#buttons');
        buttonsContainer.replaceWith(passwordInput);
      }
    } //비밀번호 입력칸이 다른 리뷰 칸에 생성되는 일이 있어서, passwordInput에 인덱스값을 붙여 특정해주고 수정, 삭제 버튼이 있던 위치에 비밀번호 입력칸과 확인, 취소 버튼이 오게 하였다.

    //삭제 시 비밀번호 확인
    function checkPasswordDelete(index) {
      const commentList = JSON.parse(localStorage.getItem('comments')) || [];
      const comment = commentList[index];
      const enteredPassword = document.getElementById('confirmPassword').value;

      if (enteredPassword === comment.password) {
        commentList.splice(index, 1); //해당 인덱스를 가진 리뷰를 1개만 삭제한다. 1이라는 숫자를 넣어주지 않으면 해당 인덱스를 가진 리뷰를 포함해 먼저 작성된 리뷰들이 전부 삭제된다.
        localStorage.removeItem('comments');
        localStorage.setItem('comments', JSON.stringify(commentList)); //업데이트된 commentList를 다시 comments로 저장한다.
        alert('리뷰가 삭제되었습니다.');
        displayComments();
      } else if (enteredPassword === '') {
        alert('비밀번호를 입력해주세요.');
        setTimeout(function () {
          const inputText = document.getElementById('confirmPassword');
          if (inputText) {
            inputText.focus();
          }
        });
      } else {
        alert('비밀번호가 틀렸습니다.');
        setTimeout(function () {
          const inputText = document.getElementById('confirmPassword');
          if (inputText) {
            inputText.focus();
          }
        });
      }
    }

    function cancelEdit(index) {
      displayComments(); // 일단 임시로 두었습니다. 나중에 고쳐야함.
    }

    displayComments();

    // window.localStorage.clear();
  </script>
</html>
