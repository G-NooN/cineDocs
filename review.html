<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>리뷰 작성</title>
    <link rel="stylesheet" href="./style/review.css" />
    <link rel="stylesheet" href="./style/reset.css" />
    <script type="module" src="./src/main.js"></script>
  </head>
  <body>
    <div class="review-box">
      <form id="comment-form">
        <div class="user-info">
          <input type="text" id="username" placeholder="이름" required />
          <input type="password" id="user-password" placeholder="비밀번호" required />
        </div>
        <div class="comment-area">
          <textarea id="comment" placeholder="리뷰를 입력하세요." required></textarea>
          <button type="button" id="submit-btn" onclick="saveComment()">등록</button>
        </div>
      </form>
      <div id="comment-list"></div>
    </div>
  </body>
  <script>
    function saveComment() {
      const name = document.querySelector("#username").value;
      const password = document.querySelector("#user-password").value;
      const commentText = document.querySelector("#comment").value;

      //유효성 검사(빈칸일 때)
      if (name === "") {
        alert("이름을 입력하세요.");
        setTimeout(function () {
          const inputText = document.getElementById("username");
          if (inputText) {
            inputText.focus();
          }
        });
        return;
      } else if (password === "") {
        alert("비밀번호를 입력하세요.");
        setTimeout(function () {
          const inputText = document.getElementById("user-password");
          if (inputText) {
            inputText.focus();
          }
        });
        return;
      } else if (commentText === "") {
        alert("내용을 입력하세요.");
        setTimeout(function () {
          const inputText = document.getElementById("comment");
          if (inputText) {
            inputText.focus();
          }
        });
        return;
      }

      //유효성 검사(글자 수 제한)
      const maxLength = 15;
      if (commentText.length > maxLength) {
        alert("리뷰는 15자 이하여야 합니다.");
        setTimeout(function () {
          const inputText = document.getElementById("comment");
          if (inputText) {
            inputText.focus();
          }
        });
        return;
      }

      const comment = {
        name,
        password,
        commentText,
      };

      const commentsList = JSON.parse(localStorage.getItem("comment-list")) || []; //JSON.parse()의 반환값이 null또는 undefined인 경우를 처리한다.

      commentsList.unshift(comment);
      //새로운 댓글을 리스트에 추가함. push 대신 unshift를 사용하여 최근 댓글이 가장 위로 오게함. push를 사용하면 최근 댓글이 가장 아래로 배치된다.
      localStorage.setItem("comment-list", JSON.stringify(commentsList)); //업데이트 된 리뷰 목록. comments에 추가된 값을 JSON 문자열화해서 commentsList에 넣어 localStorage에 저장한다.

      alert("리뷰가 등록되었습니다.");

      displayComments();
    }

    function displayComments() {
      const commentBox = document.querySelector("#comment-list");
      commentBox.innerHTML = ""; // comments의 내용이 들어갈 commentBox 변수 값을 설정해주었다.

      const commentList = JSON.parse(localStorage.getItem("comment-list")) || []; //localStorage에 comments라는 키로 저장된 데이터가 있으면 해당 데이터를 JSON 형식으로 파싱하여 반환한다. localStorage에 comments라는 키로 저장된 데이터가 없으면 빈 배열을 반환한다.

      commentList.forEach((comment, index) => {
        const newComment = document.createElement("div");
        newComment.className = "comment-item";
        newComment.innerHTML = `
        <div class="comment-box">
          <div class="comment-data">
            <p class="comment-name">${comment.name}</p>
            <p class="comment-contents">${comment.commentText}</p>
          </div>
          <div class="control-btn">
            <button onclick="editComment(${index})" id="editCommentBtn">수정</button>
            <button onclick="deleteComment(${index})" id="deleteCommentBtn">삭제</button>
          </div>
        </div>`; //commentList에 comment의 내용들을 순회하며 갖다 붙인다. 새로운 div요소를 만들고, newComment의 골격을 만들었다. 화면에 표시될 댓글에는 입력한 이름, 리뷰 내용이 들어가고, 수정 버튼과 삭제 버튼도 들어가게 된다.
        //editCommentBtn와 deleteCommentBtn에 index를 추가하여 특정 댓글을 삭제하게끔 해야한다.

        commentBox.appendChild(newComment);
      });
    }

    //리뷰 삭제
    function deleteComment(index) {
      const commentList = JSON.parse(localStorage.getItem("comments")) || [];
      const comment = commentList[index]; //배열 commentList에서 특정 index에 위치한 요소를 가져와 comment라는 변수에 할당하였다.

      const commentBox = document.getElementById("comments");

      const passwordInput = document.createElement("div");
      passwordInput.innerHTML = `
        <div class="passwordInputForm">
          <input type="password" id="confirmPassword" placeholder="비밀번호 입력" required/>
          <div id="confirmButtons">
          <button type="button" onclick="checkPasswordDelete(${index})">확인</button>
          <button type="button"
          onclick="cancelEdit(${index})">취소</button>
          </div>
          </div>
        `;

      const passwordInputId = `passwordInput_${index}`;

      const makePasswordInput = document.getElementById(passwordInputId);
      if (makePasswordInput) {
        commentBox.replaceChild(passwordInput, makePasswordInput);
      } else {
        const buttonsContainer = commentBox.children[index].querySelector("#buttons");
        buttonsContainer.replaceWith(passwordInput);
      }
    } //비밀번호 입력칸이 다른 리뷰 칸에 생성되는 일이 있어서, passwordInput에 인덱스값을 붙여 특정해주고 수정, 삭제 버튼이 있던 위치에 비밀번호 입력칸과 확인, 취소 버튼이 오게 하였다.

    //삭제 시 비밀번호 확인
    function checkPasswordDelete(index) {
      const commentList = JSON.parse(localStorage.getItem("comments")) || [];
      const comment = commentList[index];
      const enteredPassword = document.getElementById("confirmPassword").value;

      if (enteredPassword === comment.password) {
        commentList.splice(index, 1); //해당 인덱스를 가진 리뷰를 1개만 삭제한다. 1이라는 숫자를 넣어주지 않으면 해당 인덱스를 가진 리뷰를 포함해 먼저 작성된 리뷰들이 전부 삭제된다.
        localStorage.removeItem("comments");
        localStorage.setItem("comments", JSON.stringify(commentList)); //업데이트된 commentList를 다시 comments로 저장한다.
        alert("리뷰가 삭제되었습니다.");
        displayComments();
      } else if (enteredPassword === "") {
        alert("비밀번호를 입력해주세요.");
        setTimeout(function () {
          const inputText = document.getElementById("confirmPassword");
          if (inputText) {
            inputText.focus();
          }
        });
      } else {
        alert("비밀번호가 틀렸습니다.");
        setTimeout(function () {
          const inputText = document.getElementById("confirmPassword");
          if (inputText) {
            inputText.focus();
          }
        });
      }
    }

    function cancelEdit(index) {
      displayComments(); // 일단 임시로 두었습니다. 나중에 고쳐야함.
    }

    displayComments();

    // window.localStorage.clear();
  </script>
</html>
